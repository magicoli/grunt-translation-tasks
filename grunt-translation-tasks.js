const fs   = require( 'fs' );
const path = require( 'path' );

module.exports = function(grunt, pluginName) {

    'use strict';

    // Determine project type and settings
    const isWordPressProject = !!pluginName;
    const pkg = grunt.file.readJSON('package.json');
    const projectName = pluginName || path.basename(pkg.name || 'project');
    
    // Set locale paths based on project type
    const localeFolder = isWordPressProject ? 'languages' : 'locale';
    const localePoFiles = isWordPressProject ? 'languages/*.po' : 'locale/*/LC_MESSAGES/*.po';
    const potPath = isWordPressProject ? 'languages' : 'locale';

    // Helper function to update PO-Revision-Date in PO files
    function updatePoRevisionDate(poFile) {
        if (!grunt.file.exists(poFile)) {
            return false;
        }
        
        var content = grunt.file.read(poFile);
        var now = new Date();
        var timestamp = now.getFullYear() + '-' + 
                       String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(now.getDate()).padStart(2, '0') + ' ' +
                       String(now.getHours()).padStart(2, '0') + ':' + 
                       String(now.getMinutes()).padStart(2, '0') + '+0000';
        
        // Update PO-Revision-Date header
        content = content.replace(
            /"PO-Revision-Date: [^"]*"/,
            '"PO-Revision-Date: ' + timestamp + '\\n"'
        );
        
        grunt.file.write(poFile, content);
        return true;
    }

    // Helper function to get git user info synchronously
    function getGitUserInfo() {
        try {
            var spawn = require('child_process').spawnSync;
            
            var nameResult = spawn('git', ['config', 'user.name'], { encoding: 'utf8' });
            var emailResult = spawn('git', ['config', 'user.email'], { encoding: 'utf8' });
            
            var name = nameResult.stdout ? nameResult.stdout.trim() : '';
            var email = emailResult.stdout ? emailResult.stdout.trim() : '';
            
            if (name && email) {
                return name + ' <' + email + '>';
            } else if (name) {
                return name;
            } else if (email) {
                return email;
            }
        } catch (error) {
            // Silently fail if git is not available
            grunt.log.debug('Error while getting git user info: ' + error);
            return false;
        }
        return null;
    }

    // Helper function to update PO headers
    function updatePoHeaders(poFile, potFile, updateLastTranslator) {
        if (!grunt.file.exists(poFile)) {
            return false;
        }
        
        var content = grunt.file.read(poFile);
        var now = new Date();
        var timestamp = now.getFullYear() + '-' + 
                       String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                       String(now.getDate()).padStart(2, '0') + ' ' +
                       String(now.getHours()).padStart(2, '0') + ':' + 
                       String(now.getMinutes()).padStart(2, '0') + '+0000';
        
        // Update PO-Revision-Date header
        content = content.replace(
            /"PO-Revision-Date: [^"]*"/,
            '"PO-Revision-Date: ' + timestamp + '\\n"'
        );
        
        // Update POT-Creation-Date from POT file if available
        if (potFile && grunt.file.exists(potFile)) {
            var potContent = grunt.file.read(potFile);
            var potCreationMatch = potContent.match(/"POT-Creation-Date: ([^"]*)"/);
            if (potCreationMatch) {
                content = content.replace(
                    /"POT-Creation-Date: [^"]*"/,
                    '"POT-Creation-Date: ' + potCreationMatch[1] + '"'
                );
            }
        }
        
        // Update Last-Translator if requested and git info is available
        if (updateLastTranslator) {
            var gitUser = getGitUserInfo();
            var translator = gitUser || 'Generated by grunt-translation-tasks.js';
            content = content.replace(
                /"Last-Translator: [^"]*"/,
                '"Last-Translator: ' + translator + '\\n"'
            );
        }
        
        grunt.file.write(poFile, content);
        return true;
    }

    grunt.config.set('addtextdomain', {
        options: {
            textdomain: projectName,
        },
        update_all_domains: {
            options: {
                updateDomains: true
            },
            src: [ '*.php', '**/*.php', '!\.git/**/*', '!bin/**/*', '!node_modules/**/*', '!tests/**/*' ]
        }
    });

    // Custom Task: Make MO Files
    grunt.config.set('makemo', {
        target: {
            files: [{
                expand: true,
                cwd: localeFolder,
                src: isWordPressProject ? ['*.po'] : ['*/LC_MESSAGES/*.po'],
            }]
        }
    });

    grunt.config.set('makepot', {
        target: {
            options: {
                domainPath: '/' + localeFolder,
                exclude: [
                    '\.git/*',
                    'bin/*',
                    'node_modules/*',
                    'vendor/*',
                    '*/vendor/*',
                    '**/vendor/*',
                    '**/tmp/*',
                    '**/cache/*',
                    '**/data/*',
                    'cache/*',
                    'data/*',
                    'tests/*',
                    '**/tests/*',
                    'tmp/*',
                    'dev/*',
                ],
                mainFile: isWordPressProject ? `${pluginName}.php` : null,
                potFilename: `${projectName}.pot`,
                potHeaders: {
                    poedit: true,
                    'x-poedit-keywordslist': true
                },
                type: isWordPressProject ? 'wp-plugin' : 'generic',
                updateTimestamp: true
            }
        }
    });

    // Only load WP-specific plugins for WordPress projects
    if (isWordPressProject) {
        grunt.loadNpmTasks('grunt-wp-i18n');
    }

    // Register custom tasks
    if (isWordPressProject) {
        grunt.registerTask('i18n', [ 'addtextdomain', 'makepot', 'msgmerge', 'makemo' ]);
        // Register WordPress-specific tasks
        grunt.registerTask('makepot', ['makepot:target']);
        grunt.registerTask('makemo', ['makemo:target']);
    } else {
        grunt.registerTask('i18n', [ 'xgettext', 'msgmerge', 'msgfmt' ]);
        // Register non-WordPress equivalents
        grunt.registerTask('makepot', ['xgettext']);
        grunt.registerTask('makemo', ['msgfmt']);
    }

    grunt.registerTask('xgettext', 'Extract strings using xgettext for non-WordPress projects', function() {
        var done = this.async();
        var potFile = potPath + '/' + projectName + '.pot';
        var phpFiles = grunt.file.expand([
            '**/*.php',
            '!node_modules/**',

            '!vendor/**',
            '!**/vendor/**',
            '!**/tmp/**',
            '!**/data/**',
            '!**/cache/**',
            '!data/**',
            '!cache/**',
            '!tests/**',
            '!dev/**'
        ]);
        var jsFiles = grunt.file.expand([
            '**/*.js',
            '!node_modules/**',
            '!vendor/**',
            '!**/vendor/**',
            '!**/tmp/**',
            '!**/data/**',
            '!**/cache/**',
            '!data/**',
            '!cache/**',
            '!tests/**',
            '!dev/**'
        ]);

        
        var allFiles = phpFiles.concat(jsFiles);
        // DEBUG show files to about to be processed and die
        grunt.log.writeln('Files to be processed:');
        allFiles.forEach(function(file) {
            grunt.log.writeln(' - ' + file);
        });

        // DEBUG end in all case, to test the files compilation method, do not remove
        return done(true);
        
        if (!allFiles.length) {
            grunt.log.error('No PHP or JS files found for extraction');
            return done(false);
        }
        
        grunt.util.spawn({
            cmd: 'xgettext',
            args: [
                '--language=PHP',
                '--keyword=_',
                '--keyword=__',
                '--keyword=_e',
                '--keyword=_c:1,2c',
                '--keyword=_x:1,2c',
                '--keyword=_ex:1,2c',
                '--keyword=_n:1,2',
                '--keyword=_nx:1,2,4c',
                '--keyword=_n_noop:1,2',
                '--keyword=_nx_noop:1,2,3c',
                '--keyword=_f',
                '--keyword=_fe',
                '--keyword=_p:1,2',
                '--keyword=_pf:1,2',
                '--keyword=_pfe:1,2',
                '--keyword=_m',
                '--keyword=esc_attr__',
                '--keyword=esc_html__',
                '--keyword=esc_attr_e',
                '--keyword=esc_html_e',
                '--keyword=esc_attr_x:1,2c',
                '--keyword=esc_html_x:1,2c',
                '--from-code=UTF-8',
                '--add-comments=translators',
                '--output=' + potFile
            ].concat(allFiles)
        }, function(error, result, code) {
            if (error) {
                grunt.log.error('Error running xgettext: ' + error);
                return done(false);
            }
            grunt.log.writeln('Generated POT file: ' + potFile);
            grunt.log.writeln('Extracted strings from ' + phpFiles.length + ' PHP files and ' + jsFiles.length + ' JS files');
            done();
        });
    });

    grunt.registerTask('msgmerge', 'Update PO files with new POT content', function() {
        var done = this.async();
        var poFiles = grunt.file.expand(localePoFiles);
        var potFile = potPath + '/' + projectName + '.pot';

        if (!grunt.file.exists(potFile)) {
            grunt.log.error('POT file not found: ' + potFile);
            return done(false);
        }

        if (!poFiles.length) {
            grunt.log.writeln('No PO files found - skipping msgmerge');
            return done();
        }

        var completed = 0;
        var hasErrors = false;

        poFiles.forEach(function(poFile) {
            grunt.util.spawn({
                cmd: 'msgmerge',
                args: ['--update', '--backup=off', poFile, potFile]
            }, function(error, result, code) {
                if (error) {
                    grunt.log.error('Error merging ' + poFile + ': ' + error);
                    hasErrors = true;
                } else {
                    // Update headers after successful merge
                    updatePoHeaders(poFile, potFile, true);
                    grunt.log.writeln('Updated ' + poFile + ' with new strings from POT');
                }
                completed++;
                if (completed === poFiles.length) {
                    done(!hasErrors);
                }
            });
        });
    });

    grunt.registerTask('msgfmt', 'Convert PO files to MO using msgfmt for non-WordPress projects', function() {
        var done = this.async();
        var poFiles = grunt.file.expand(localePoFiles);

        if (!poFiles.length) {
            grunt.log.error('No PO files found');
            return done(false);
        }

        var completed = 0;
        var hasErrors = false;

        poFiles.forEach(function(poFile) {
            var moFile = poFile.replace(/\.po$/, '.mo');
            
            // Update headers before conversion
            updatePoHeaders(poFile, null, true);
            
            grunt.util.spawn({
                cmd: 'msgfmt',
                args: ['-o', moFile, poFile]
            }, function(error, result, code) {
                if (error) {
                    grunt.log.error('Error processing ' + poFile + ': ' + error);
                    hasErrors = true;
                } else {
                    grunt.log.writeln('Converted ' + poFile + ' to ' + moFile);
                }
                completed++;
                if (completed === poFiles.length) {
                    done(!hasErrors);
                }
            });
        });
    });

    grunt.registerTask('makemo', 'Convert PO files to MO using WP CLI for WordPress projects', function() {
        var done = this.async();
        var poFiles = grunt.file.expand(localePoFiles);

        if (!poFiles.length) {
            grunt.log.error('No PO files found');
            return done(false);
        }

        var completed = 0;
        poFiles.forEach(function(poFile) {
            // Update headers before conversion
            updatePoHeaders(poFile, null, true);
            
            grunt.util.spawn({
                cmd: 'wp',
                args: ['i18n', 'make-mo', poFile]
            }, function(error, result, code) {
                if (error) {
                    grunt.log.error('Error processing ' + poFile + ': ' + error);
                    return done(false);
                }
                grunt.log.writeln('Converted ' + poFile);
                completed++;
                if (completed === poFiles.length) {
                    done();
                }
            });
        });
    });

    grunt.util.linefeed = '\n';

};
